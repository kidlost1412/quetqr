<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‚ö° TikTok Barcode Scanner</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
  <style>
    :root {
      --primary: #fe2c55;
      --success: #00c853;
      --warning: #ff9800;
      --bg: #000;
      --card: #111;
      --card2: #1a1a1a;
      --text: #fff;
      --text2: #666;
      --border: #222;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }
    
    .logo { font-weight: 700; font-size: 1rem; }
    .logo span { color: var(--primary); }
    
    .engine {
      font-size: 0.6rem;
      padding: 4px 8px;
      background: var(--card);
      border: 1px solid var(--success);
      border-radius: 10px;
      color: var(--success);
    }
    
    /* Scanner */
    .scanner {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      background: #000;
      overflow: hidden;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .frame {
      width: 72%;
      height: 72%;
      border: 2px solid var(--primary);
      border-radius: 12px;
      position: relative;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    }
    
    .laser {
      position: absolute;
      left: 8%; right: 8%;
      height: 2px;
      background: var(--primary);
      box-shadow: 0 0 8px var(--primary);
      animation: scan 1.8s ease-in-out infinite;
    }
    
    @keyframes scan {
      0%, 100% { top: 8%; }
      50% { top: 92%; }
    }
    
    .flash {
      position: absolute;
      inset: 0;
      background: var(--success);
      opacity: 0;
      transition: opacity 0.1s;
      pointer-events: none;
    }
    
    .flash.on { opacity: 0.25; }
    .flash.dup { background: var(--warning); }
    
    .perf {
      position: absolute;
      bottom: 6px;
      left: 6px;
      font: 500 0.55rem/1 monospace;
      color: rgba(255,255,255,0.6);
      background: rgba(0,0,0,0.5);
      padding: 3px 6px;
      border-radius: 4px;
    }
    
    /* Status */
    .status {
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    
    .status.ok { background: rgba(0,200,83,0.12); color: var(--success); }
    .status.dup { background: rgba(255,152,0,0.12); color: var(--warning); }
    
    /* Result */
    .result {
      display: none;
      margin: 10px;
      padding: 14px;
      background: var(--card);
      border-radius: 10px;
      border-left: 3px solid var(--success);
    }
    
    .result.show { display: block; animation: pop 0.25s ease; }
    .result.dup { border-color: var(--warning); }
    
    @keyframes pop {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .result-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 3px 8px;
      background: var(--success);
      color: #fff;
      border-radius: 8px;
    }
    
    .result.dup .badge { background: var(--warning); }
    
    .result-time { font-size: 0.7rem; color: var(--text2); }
    
    .result-code {
      font: 600 1rem/1.3 'SF Mono', 'Consolas', monospace;
      word-break: break-all;
    }
    
    .dup-info {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,152,0,0.08);
      border-radius: 8px;
      font-size: 0.8rem;
    }
    
    .result.dup .dup-info { display: block; }
    
    .dup-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }
    
    .dup-label { color: var(--text2); }
    .dup-val { font-weight: 600; }
    
    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 10px;
    }
    
    .stat {
      background: var(--card);
      padding: 12px 8px;
      border-radius: 10px;
      text-align: center;
    }
    
    .stat-num {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.6rem;
      color: var(--text2);
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    /* Actions */
    .actions {
      display: flex;
      gap: 8px;
      padding: 0 10px 10px;
    }
    
    .btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    
    .btn-secondary {
      background: var(--card2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    /* History */
    .section-title {
      padding: 10px;
      font-size: 0.75rem;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .history {
      background: var(--card);
      margin: 0 10px 80px;
      border-radius: 10px;
      max-height: 280px;
      overflow-y: auto;
    }
    
    .history::-webkit-scrollbar { width: 3px; }
    .history::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    
    .history-empty {
      padding: 30px;
      text-align: center;
      color: var(--text2);
      font-size: 0.8rem;
    }
    
    .h-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .h-item:last-child { border: none; }
    
    .h-num {
      width: 22px; height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      font-size: 0.6rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .h-content { flex: 1; min-width: 0; }
    
    .h-code {
      font: 500 0.8rem/1.2 monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .h-time {
      font-size: 0.65rem;
      color: var(--text2);
    }
    
    .h-count {
      font-size: 0.65rem;
      padding: 2px 7px;
      background: var(--bg);
      border-radius: 8px;
      color: var(--text2);
    }
    
    .h-count.multi { background: rgba(255,152,0,0.15); color: var(--warning); }
    
    /* Date selector */
    .date-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      margin-bottom: 6px;
    }
    
    .date-input {
      flex: 1;
      padding: 8px 10px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.8rem;
    }
    
    .date-input:focus { outline: none; border-color: var(--primary); }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      padding: 16px;
    }
    
    .modal.show { opacity: 1; visibility: visible; }
    
    .modal-box {
      width: 100%;
      max-width: 360px;
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      transform: scale(0.9);
      transition: transform 0.2s;
    }
    
    .modal.show .modal-box { transform: scale(1); }
    
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .modal-info {
      font-size: 0.8rem;
      color: var(--text2);
      text-align: center;
      margin-bottom: 16px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">üì¶ <span>TikTok</span> Scanner</div>
    <div class="engine" id="engine">ƒêang kh·ªüi ƒë·ªông...</div>
  </header>
  
  <!-- Scanner -->
  <section class="scanner">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div class="overlay">
      <div class="frame">
        <div class="laser"></div>
      </div>
    </div>
    <div class="flash" id="flash"></div>
    <div class="perf" id="perf">-- FPS | -- ms</div>
  </section>
  
  <!-- Status -->
  <div class="status" id="status">üì∑ ƒêang kh·ªüi ƒë·ªông camera...</div>
  
  <!-- Result -->
  <div class="result" id="result">
    <div class="result-top">
      <span class="badge" id="badge">‚úÖ M·ªöI</span>
      <span class="result-time" id="rTime">--:--:--</span>
    </div>
    <div class="result-code" id="rCode">-</div>
    <div class="dup-info">
      <div class="dup-row">
        <span class="dup-label">L·∫ßn ƒë·∫ßu:</span>
        <span class="dup-val" id="dTime">-</span>
      </div>
      <div class="dup-row">
        <span class="dup-label">V·ªã tr√≠:</span>
        <span class="dup-val" id="dPos">-</span>
      </div>
      <div class="dup-row">
        <span class="dup-label">S·ªë l·∫ßn:</span>
        <span class="dup-val" id="dCount">-</span>
      </div>
    </div>
  </div>
  
  <!-- Stats -->
  <div class="stats">
    <div class="stat">
      <div class="stat-num" id="sTotal">0</div>
      <div class="stat-label">T·ªïng</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="sUnique">0</div>
      <div class="stat-label">Duy nh·∫•t</div>
    </div>
    <div class="stat">
      <div class="stat-num" id="sDup">0</div>
      <div class="stat-label">Tr√πng</div>
    </div>
  </div>
  
  <!-- Actions -->
  <div class="actions">
    <button class="btn btn-primary" id="btnExport">üì• Xu·∫•t Excel</button>
    <button class="btn btn-secondary" id="btnClear">üóëÔ∏è X√≥a h√¥m nay</button>
  </div>
  
  <!-- History -->
  <div class="section-title">üìú L·ªãch s·ª≠ qu√©t</div>
  <div class="date-bar">
    <input type="date" class="date-input" id="dateInput">
  </div>
  <div class="history" id="history">
    <div class="history-empty">Ch∆∞a c√≥ m√£ n√†o</div>
  </div>
  
  <!-- Export Modal -->
  <div class="modal" id="modalExport">
    <div class="modal-box">
      <div class="modal-title">üì• Xu·∫•t d·ªØ li·ªáu Excel</div>
      <div class="modal-info">Ch·ªçn ng√†y ƒë·ªÉ xu·∫•t ho·∫∑c xu·∫•t t·∫•t c·∫£</div>
      <div class="date-bar" style="margin-bottom:12px">
        <input type="date" class="date-input" id="exportDate">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnExportDay">üìÖ Ng√†y n√†y</button>
        <button class="btn btn-primary" id="btnExportAll">üì¶ T·∫•t c·∫£</button>
      </div>
      <button class="btn btn-secondary" style="margin-top:10px;width:100%" id="btnCloseExport">ƒê√≥ng</button>
    </div>
  </div>
  
  <!-- Clear Modal -->
  <div class="modal" id="modalClear">
    <div class="modal-box">
      <div class="modal-title">üóëÔ∏è X√≥a d·ªØ li·ªáu?</div>
      <div class="modal-info">X√≥a to√†n b·ªô d·ªØ li·ªáu ng√†y <strong id="clearDate">--</strong>?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnCancelClear">H·ªßy</button>
        <button class="btn btn-primary" style="background:#f44336" id="btnConfirmClear">X√≥a</button>
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <script>
    /**
     * ‚ö° TIKTOK BARCODE SCANNER - OFFLINE EDITION
     * 
     * Features:
     * - BarcodeDetector Native API (GPU accelerated)
     * - IndexedDB for persistent storage
     * - Export to Excel (SheetJS)
     * - Zero network dependency
     */
    
    // ============================================
    // CONFIG
    // ============================================
    const CONFIG = {
      DB_NAME: 'TikTokScanner',
      DB_VERSION: 1,
      STORE_NAME: 'scans',
      COOLDOWN: 2000,
      SCAN_INTERVAL: 80
    };
    
    // ============================================
    // STATE
    // ============================================
    const state = {
      db: null,
      detector: null,
      scanning: true,
      lastCode: null,
      lastTime: 0,
      todayCache: new Map(),
      stats: { total: 0, unique: 0, dup: 0 },
      currentDate: formatDate(new Date()),
      fps: 0,
      frameCount: 0,
      lastFpsTime: Date.now(),
      scanTimes: []
    };
    
    // ============================================
    // DOM
    // ============================================
    const $ = id => document.getElementById(id);
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    // ============================================
    // INDEXED DB
    // ============================================
    function initDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
        
        req.onerror = () => reject(req.error);
        
        req.onsuccess = () => {
          state.db = req.result;
          resolve();
        };
        
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(CONFIG.STORE_NAME)) {
            const store = db.createObjectStore(CONFIG.STORE_NAME, { keyPath: 'id', autoIncrement: true });
            store.createIndex('date', 'date', { unique: false });
            store.createIndex('code', 'code', { unique: false });
            store.createIndex('dateCode', ['date', 'code'], { unique: false });
          }
        };
      });
    }
    
    async function saveScan(data) {
      return new Promise((resolve, reject) => {
        const tx = state.db.transaction(CONFIG.STORE_NAME, 'readwrite');
        const store = tx.objectStore(CONFIG.STORE_NAME);
        const req = store.add(data);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function updateScan(id, data) {
      return new Promise((resolve, reject) => {
        const tx = state.db.transaction(CONFIG.STORE_NAME, 'readwrite');
        const store = tx.objectStore(CONFIG.STORE_NAME);
        const req = store.put({ ...data, id });
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }
    
    async function getScansByDate(date) {
      return new Promise((resolve, reject) => {
        const tx = state.db.transaction(CONFIG.STORE_NAME, 'readonly');
        const store = tx.objectStore(CONFIG.STORE_NAME);
        const index = store.index('date');
        const req = index.getAll(date);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function getAllScans() {
      return new Promise((resolve, reject) => {
        const tx = state.db.transaction(CONFIG.STORE_NAME, 'readonly');
        const store = tx.objectStore(CONFIG.STORE_NAME);
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    
    async function clearByDate(date) {
      const scans = await getScansByDate(date);
      const tx = state.db.transaction(CONFIG.STORE_NAME, 'readwrite');
      const store = tx.objectStore(CONFIG.STORE_NAME);
      for (const scan of scans) {
        store.delete(scan.id);
      }
      return new Promise(resolve => tx.oncomplete = resolve);
    }
    
    async function getAllDates() {
      const all = await getAllScans();
      const dates = [...new Set(all.map(s => s.date))];
      return dates.sort().reverse();
    }
    
    // ============================================
    // AUDIO
    // ============================================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function beep(freq, dur) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      gain.gain.value = 0.25;
      osc.start();
      setTimeout(() => osc.stop(), dur);
    }
    
    function playOk() { beep(1800, 60); setTimeout(() => beep(2400, 60), 80); }
    function playDup() { beep(350, 200); }
    
    // ============================================
    // SCANNER
    // ============================================
    async function initScanner() {
      if (!('BarcodeDetector' in window)) {
        $('engine').textContent = '‚ùå Kh√¥ng h·ªó tr·ª£';
        $('status').textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ BarcodeDetector';
        return false;
      }
      
      try {
        const formats = await BarcodeDetector.getSupportedFormats();
        state.detector = new BarcodeDetector({
          formats: ['qr_code', 'code_128', 'code_39', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
            .filter(f => formats.includes(f))
        });
        $('engine').textContent = '‚ö° Native GPU';
        return true;
      } catch (e) {
        $('engine').textContent = '‚ùå L·ªói';
        return false;
      }
    }
    
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        return true;
      } catch (e) {
        $('status').textContent = '‚ùå L·ªói camera: ' + e.message;
        return false;
      }
    }
    
    function startScanLoop() {
      const scan = async () => {
        if (!state.scanning) {
          setTimeout(scan, CONFIG.SCAN_INTERVAL);
          return;
        }
        
        const t0 = performance.now();
        
        try {
          ctx.drawImage(video, 0, 0);
          const codes = await state.detector.detect(canvas);
          
          if (codes.length > 0) {
            await handleScan(codes[0].rawValue.trim());
          }
        } catch (e) {}
        
        // Perf
        const dt = performance.now() - t0;
        state.scanTimes.push(dt);
        if (state.scanTimes.length > 15) state.scanTimes.shift();
        
        state.frameCount++;
        const now = Date.now();
        if (now - state.lastFpsTime >= 1000) {
          state.fps = state.frameCount;
          state.frameCount = 0;
          state.lastFpsTime = now;
          const avg = state.scanTimes.reduce((a,b) => a+b, 0) / state.scanTimes.length;
          $('perf').textContent = `${state.fps} FPS | ${avg.toFixed(1)} ms`;
        }
        
        setTimeout(scan, CONFIG.SCAN_INTERVAL);
      };
      scan();
    }
    
    // ============================================
    // SCAN HANDLER
    // ============================================
    async function handleScan(code) {
      const now = Date.now();
      
      // Cooldown
      if (code === state.lastCode && now - state.lastTime < CONFIG.COOLDOWN) return;
      
      state.lastCode = code;
      state.lastTime = now;
      state.scanning = false;
      
      const time = formatTime();
      const date = formatDate(new Date());
      
      // Check duplicate in today's cache
      let isDup = false;
      let dupInfo = null;
      
      if (state.todayCache.has(code)) {
        isDup = true;
        dupInfo = state.todayCache.get(code);
        dupInfo.count++;
        dupInfo.lastTime = time;
        await updateScan(dupInfo.id, dupInfo);
        state.stats.dup++;
        flash(true);
        playDup();
      } else {
        const newScan = {
          code,
          date,
          time,
          count: 1,
          position: state.stats.unique + 1
        };
        const id = await saveScan(newScan);
        newScan.id = id;
        state.todayCache.set(code, newScan);
        state.stats.unique++;
        flash(false);
        playOk();
        dupInfo = newScan;
      }
      
      state.stats.total++;
      
      // UI
      showResult(code, isDup, dupInfo);
      updateStats();
      addToHistory(code, time, dupInfo);
      
      setStatus(isDup ? 'dup' : 'ok', isDup ? '‚ö†Ô∏è M√É TR√ôNG!' : '‚úÖ ƒê√£ l∆∞u!');
      
      setTimeout(() => {
        state.scanning = true;
        setStatus('', 'üì∑ S·∫µn s√†ng qu√©t');
      }, CONFIG.COOLDOWN);
    }
    
    // ============================================
    // UI
    // ============================================
    function setStatus(type, text) {
      $('status').className = 'status ' + type;
      $('status').textContent = text;
    }
    
    function flash(isDup) {
      const el = $('flash');
      el.className = 'flash on' + (isDup ? ' dup' : '');
      setTimeout(() => el.className = 'flash', 120);
    }
    
    function showResult(code, isDup, info) {
      const el = $('result');
      el.className = 'result show' + (isDup ? ' dup' : '');
      $('rCode').textContent = code;
      $('rTime').textContent = formatTime();
      $('badge').textContent = isDup ? '‚ö†Ô∏è TR√ôNG' : '‚úÖ M·ªöI';
      
      if (isDup) {
        $('dTime').textContent = info.time;
        $('dPos').textContent = '#' + info.position;
        $('dCount').textContent = info.count;
      }
    }
    
    function updateStats() {
      $('sTotal').textContent = state.stats.total;
      $('sUnique').textContent = state.stats.unique;
      $('sDup').textContent = state.stats.dup;
    }
    
    function addToHistory(code, time, info) {
      const list = $('history');
      const empty = list.querySelector('.history-empty');
      if (empty) empty.remove();
      
      let item = list.querySelector(`[data-code="${CSS.escape(code)}"]`);
      
      if (item) {
        const cnt = item.querySelector('.h-count');
        cnt.textContent = '√ó' + info.count;
        cnt.classList.toggle('multi', info.count > 1);
        list.insertBefore(item, list.firstChild);
      } else {
        item = document.createElement('div');
        item.className = 'h-item';
        item.dataset.code = code;
        item.innerHTML = `
          <div class="h-num">${info.position}</div>
          <div class="h-content">
            <div class="h-code">${escapeHtml(code)}</div>
            <div class="h-time">${time}</div>
          </div>
          <div class="h-count">√ó${info.count}</div>
        `;
        list.insertBefore(item, list.firstChild);
      }
    }
    
    async function loadHistory(date) {
      const scans = await getScansByDate(date);
      const list = $('history');
      list.innerHTML = '';
      
      if (scans.length === 0) {
        list.innerHTML = '<div class="history-empty">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
        return;
      }
      
      // Sort by position desc
      scans.sort((a, b) => b.position - a.position);
      
      for (const scan of scans) {
        const item = document.createElement('div');
        item.className = 'h-item';
        item.dataset.code = scan.code;
        item.innerHTML = `
          <div class="h-num">${scan.position}</div>
          <div class="h-content">
            <div class="h-code">${escapeHtml(scan.code)}</div>
            <div class="h-time">${scan.time}</div>
          </div>
          <div class="h-count ${scan.count > 1 ? 'multi' : ''}">√ó${scan.count}</div>
        `;
        list.appendChild(item);
      }
    }
    
    async function loadTodayCache() {
      const scans = await getScansByDate(state.currentDate);
      state.todayCache.clear();
      state.stats = { total: 0, unique: 0, dup: 0 };
      
      for (const scan of scans) {
        state.todayCache.set(scan.code, scan);
        state.stats.unique++;
        state.stats.total += scan.count;
        state.stats.dup += scan.count - 1;
      }
      
      updateStats();
      await loadHistory(state.currentDate);
    }
    
    // ============================================
    // EXPORT EXCEL
    // ============================================
    async function exportToExcel(date = null) {
      let scans;
      let filename;
      
      if (date) {
        scans = await getScansByDate(date);
        filename = `TikTok_Scanner_${date}.xlsx`;
      } else {
        scans = await getAllScans();
        filename = `TikTok_Scanner_ALL_${formatDate(new Date())}.xlsx`;
      }
      
      if (scans.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }
      
      // Group by date
      const byDate = {};
      for (const s of scans) {
        if (!byDate[s.date]) byDate[s.date] = [];
        byDate[s.date].push(s);
      }
      
      const wb = XLSX.utils.book_new();
      
      for (const [d, items] of Object.entries(byDate)) {
        items.sort((a, b) => a.position - b.position);
        
        const data = items.map(s => ({
          'STT': s.position,
          'Gi·ªù qu√©t': s.time,
          'M√£ v·∫°ch': s.code,
          'S·ªë l·∫ßn qu√©t': s.count
        }));
        
        const ws = XLSX.utils.json_to_sheet(data);
        
        // Column widths
        ws['!cols'] = [
          { wch: 6 },
          { wch: 12 },
          { wch: 25 },
          { wch: 12 }
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, d);
      }
      
      XLSX.writeFile(wb, filename);
    }
    
    // ============================================
    // UTILITIES
    // ============================================
    function formatTime() {
      return new Date().toLocaleTimeString('vi-VN', {
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }
    
    function formatDate(d) {
      return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
    }
    
    function parseDate(str) {
      const [d, m, y] = str.split('-');
      return `${y}-${m}-${d}`;
    }
    
    function toDisplayDate(str) {
      const [y, m, d] = str.split('-');
      return `${d}-${m}-${y}`;
    }
    
    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    
    // ============================================
    // EVENT HANDLERS
    // ============================================
    function setupEvents() {
      // Date input
      const dateInput = $('dateInput');
      dateInput.value = parseDate(state.currentDate);
      dateInput.max = parseDate(state.currentDate);
      
      dateInput.onchange = async () => {
        const selected = toDisplayDate(dateInput.value);
        await loadHistory(selected);
      };
      
      // Export
      $('btnExport').onclick = () => {
        $('exportDate').value = parseDate(state.currentDate);
        $('modalExport').classList.add('show');
      };
      
      $('btnCloseExport').onclick = () => $('modalExport').classList.remove('show');
      
      $('btnExportDay').onclick = async () => {
        const date = toDisplayDate($('exportDate').value);
        await exportToExcel(date);
        $('modalExport').classList.remove('show');
      };
      
      $('btnExportAll').onclick = async () => {
        await exportToExcel(null);
        $('modalExport').classList.remove('show');
      };
      
      // Clear
      $('btnClear').onclick = () => {
        $('clearDate').textContent = state.currentDate;
        $('modalClear').classList.add('show');
      };
      
      $('btnCancelClear').onclick = () => $('modalClear').classList.remove('show');
      
      $('btnConfirmClear').onclick = async () => {
        await clearByDate(state.currentDate);
        state.todayCache.clear();
        state.stats = { total: 0, unique: 0, dup: 0 };
        updateStats();
        $('history').innerHTML = '<div class="history-empty">ƒê√£ x√≥a</div>';
        $('result').className = 'result';
        $('modalClear').classList.remove('show');
      };
      
      // Modal backdrop click
      $('modalExport').onclick = e => {
        if (e.target === $('modalExport')) $('modalExport').classList.remove('show');
      };
      $('modalClear').onclick = e => {
        if (e.target === $('modalClear')) $('modalClear').classList.remove('show');
      };
    }
    
    // ============================================
    // INIT
    // ============================================
    async function init() {
      setStatus('', 'üîÑ ƒêang kh·ªüi ƒë·ªông...');
      
      await initDB();
      await loadTodayCache();
      
      const scannerOk = await initScanner();
      if (!scannerOk) return;
      
      const cameraOk = await initCamera();
      if (!cameraOk) return;
      
      setupEvents();
      startScanLoop();
      
      setStatus('', 'üì∑ S·∫µn s√†ng qu√©t');
    }
    
    init();
  </script>
</body>
</html>
